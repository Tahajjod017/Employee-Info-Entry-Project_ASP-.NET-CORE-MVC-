@model Employeeinfo

@{
    ViewData["Title"] = "Employee Information Entry";
    var departments = ViewBag.Departments as List<EmployeeMvc.Models.Department>;
    var designations = ViewBag.Designation as List<EmployeeMvc.Models.Designation>;
    var employee = ViewBag.emp as List<EmployeeMvc.Models.Employeeinfo>;
}
<style>
    .pagination-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;

    }
</style>
<div width="100%" class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white ">
                    <h4>Employee Information Entry</h4>
                </div>
                <div class="card-body">

                    <form id="employeeForm" @* asp-action="Save" method="post" *@>
                        <div class="row mt-2">
                            <div class="col-9 mb-4 text-end">
                                <button type="submit" id="saveBtn" class="btn btn-lg btn-success me-2">Save</button>
                                <button type="button" id="deleteBtn" class="btn btn-lg btn-danger me-2">Delete</button>
                                <button type="button" id="clearBtn" class="btn btn-lg btn-secondary">Clear</button>
                            </div>
                        </div>
                        <input type="hidden" asp-for="AutoID" name="AutoID" value="0" />
                        <div class="row">
                            <!-- Left Column (Form Fields) - col-10 -->
                            <div class="col-10">
                                <!-- Row 1: Employee ID | Empty -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Employee ID</label>
                                            <div class="col-sm-8">
                                                <input type="text" asp-for="EmployeeID" class="form-control" readonly/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <!-- Empty -->
                                    </div>
                                </div>
                                <!-- Row 2: Name | Designation -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Name:</label>
                                            <div class="col-sm-8">
                                                <input type="text" asp-for="Name" name="Name" class="form-control" required oninvalid="this.setCustomValidity('Please Enter Your Name')"
                                                oninput="this.setCustomValidity('')"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Designation:</label>
                                            <div class="col-sm-7">
                                                <select asp-for="Designation" name="Designation" class="form-control" >
                                                    <option value= "">Choose</option >
                                                    @* @if (designations != null)
                                                    {
                                                        foreach (var designation in designations)
                                                        {
                                                            <option value="@designation.DesignationId.ToString()">@designation.DesignationName</option>
                                                        }
                                                    } *@
                                                </select>
                                            </div>
                                            <div class="col-sm-1">
                                                <span class="text-success"></span>
                                                <button type="button" id="loadDesignationModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">+
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 3: Department | Salary -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Department:</label>
                                            <div class="col-sm-7">
                                                <select asp-for="Department" name="Department" class="form-control">
                                                    @if (departments != null)
                                                    {
                                                        foreach (var dept in departments)
                                                        {     
                                                            <option value="">Select Department</option>
                                                            <option value="@dept.DepartmentId.ToString()">@dept.DepartmentName</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-sm-1">

                                                <span class="text-success">
                                                    <button type="button" id= "loadDepartmentModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#DepartmentModal">
                                                        +
                                                    </button>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Gross Salary:</label>
                                            <div class="col-sm-8">
                                                <input type="number" id="GrossSalary" name="GrossSalary" class="form-control" step="1" Fixed min="0"  />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 4: Joining Date | Empty -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Joining Date:</label>
                                            <div class="col-sm-8">
                                                <input type="date" id="JoiningDate" name="JoiningDate" class="form-control"  />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <!-- Empty -->
                                    </div>
                                </div>

                                <!-- Row 5: Address | Phone -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Address:</label>
                                            <div class="col-sm-8">
                                                <textarea id="Address" name="Address" class="form-control" rows="3"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Phone:</label>
                                            <div class="col-sm-8">
                                                <input type="tel" id="Phone" name="Phone" class="form-control" required oninvalid="this.setCustomValidity('Please Enter Phone')" oninput="this.setCustomValidity('')" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 6: Email | Photo Upload -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Email:</label>
                                            <div class="col-sm-8">
                                                <input type="email" id="Email" name="Email" class="form-control"  />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <label class="col-sm-4 col-form-label text-end">Photo:</label>
                                            <div class="col-sm-6">
                                                <input asp-for="photo" type="file" class="form-control" accept="image/*" />
                                                @* <input type="hidden" id="Photo" name="Photo" /> *@
                                            </div>

                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Right Column (Photo Preview) - col-2 -->
                            <div class="col-2">
                                <div class="text-center">
                                    <label class="form-label">Photo Preview:</label>
                                    <div class="border mt-2" style="width: 100%; height: 150px;">
                                        <img id="photoPreview" src="" alt="Photo Preview" style="width: 100%; height: 100%; object-fit: cover; display: none;" />
                                        <div id="photoPlaceholder" class="d-flex align-items-center justify-content-center h-100">
                                            <span class="text-muted" id="photoPHText">Insert Photo</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-12 text-center mt-3">
                                        <button type="button" id="pic_clearBtn" class="btn btn-sm btn-outline-secondary w-50">Clear</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <!--Employee Data Grid View-->
                    <div class="table-responsive"></div>
                    <div class=" table section">
                        <div class=" row mb-3">
                            <div class=" col-md-6">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">Grid Show:</span>
                                    <select class="form-select"style="width:80px;">
                                        <option>10</option>
                                        <option>25</option>
                                        <option>50</option>
                                        <option>100</option>                                    
                                    </select>
                                    <span class="ms-2">entries</span> 
                                </div>
                            </div>
                            <div class="col-md-6"> 
                                <div class="d-flex justify-content-end">
                                    <input type="text" class="form-control" placeholder="Search" style="width:200px" />
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="employeeTable" class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th width="10%" class="text-center">Select All <input type="checkbox" id="selectAll" /></th>
                                        <th>Emp.ID</th>
                                        <th>Name</th>
                                        <th>Designation</th>
                                        <th>Department</th>
                                        <th>GrossSalary</th>
                                        <th>JoiningDate</th>
                                        <th style="width: 80px; text-align: center;"> Photo </th>
                                        <th>action</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    @if (ViewBag.emp != null)
                                    {
                                        foreach (var emp in ViewBag.emp)
                                        {
                                            <tr>
                                                <td class="text-center" width="10%"><input type="checkbox" class="selectsingle" name="selectedItems" value="@emp.AutoID"/></td>
                                                <td>@emp.EmployeeID</td>
                                                <td>@emp.Name</td>
                                                <td>@emp.Designation</td>
                                                <td>@emp.Department</td>
                                                <td>@emp.GrossSalary</td>
                                                <td>@emp.JoiningDate?.ToString("yyyy-MM-dd")</td>

                                                <td>
                                                    @if (!string.IsNullOrEmpty(emp.PhotoPath))
                                                    {
                                                        <img src="~/Image/@emp.PhotoPath" alt="Employee Photo"
                                                             style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"
                                                             class="img-thumbnail"  />
                                                    }
                                                    else
                                                    {

                                                        <span class="text-muted align-content-center w-50">👤</span>    
                                                    }
                                                </td>
                                                <td><button type="button" class="editBtn btn btn-sm btn-outline-secondary w-10%" data-id =@emp.EmployeeID>Edit</button></td>

                                            </tr>
                                        }
                                    }
                                    else
                                    {
			                    	    <tr>
											<td>No Data found</td>
                                        </tr>
                                    }

                               </tbody>

                           </table>
                       </div>
                       <div class="pagination-section">
                           <div>
                               <span class="text-muted">Showing 1 to 10 of 15 entries</span>
                           </div>
                           <nav>
                               <ul class="pagination mb-0">
                                   <li class="page-item">
                                   <a class="page-link"href="#">First</a>
                                   </li>
                                   <li class="page-item">
                                       <a class="page-link"href="#">Previous</a>
                                   </li>
                                   <li class="page-item">
                                       <a class="page-link"href="#">Previous</a>

                                   </li>
                                   <li class="page-item">
                                       <a class="page-link"href="#">1</a>

                                   </li>
                                   <li class="page-item">
                                       <a class="page-link"href="#">2</a>
                                   </li>
                                   <li class="page-item">
                                       <a class="page-link"href="#">Next</a>

                                   </li>
                                   <li class="page-item">
                                       <a class="page-link"href="#">Last</a>
                                   </li>
                               </ul>
                           </nav>
                       </div>
                    </div>
                    <div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--Designation Modal-->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="desigModalBody">        
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>
<!--Department Modal-->
<div class="modal fade" id="DepartmentModal" tabindex="-1" aria-labelledby="DepartmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="DepartmentModalLabel">Modal title</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="DepartmentModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
    $(document).ready(function () {
        // Initial Data Loads
        DesignationDD();
        DepartmentDD();
        GetEmployeeNextID();

        // Modal Load Events
        $('#loadDesignationModal').on('click', function () {
            $('#desigModalBody').load('/Designation/Index?isPartial=true', function () {
                DesignationDD(); // Optional: reload if modal content includes dropdown
            });
        });
        $('#loadDepartmentModal').on('click', function () {
            $('#DepartmentModalBody').load('/Department/Index?isPartial=true', function () {
                DepartmentDD(); // Optional: reload if modal content includes dropdown
            });
        });
    });

    // 🔄 Load Designations
    function DesignationDD() {
        $.get('/Designation/GetAll', function (designations) {
            var $dropdown = $('#Designation');
            $dropdown.empty();

            $dropdown.append($('<option>', {
                value: '',
                text: 'Select Designation...',
                disabled: true,
                selected: true
            }));

            $.each(designations, function (i, item) {
                $dropdown.append($('<option>', {
                    value: item.designationId,
                    text: item.designationName
                }));
            });
        });
    }

    // 🔄 Load Departments
    function DepartmentDD() {
        $.get('/Department/GetAll', function (departments) {
            var $dropdown = $('#Department');
            $dropdown.empty();
            
            $dropdown.append($('<option>', {
                value: '',
                text: 'Select Department...',
                disabled: true,
                selected: true
            }));

            $.each(departments, function (i, item) {
                $dropdown.append($('<option>', {
                    value: item.departmentId,
                    text: item.departmentName
                }));
            });
        });
    }

    // 📄 Auto-generate Next Employee ID
    function GetEmployeeNextID() {
        $.ajax({
            url: 'EmployeeInfoController1/GetEmployeeNextID',
            type: 'GET',
            success: function (data) {
                console.log("Next Employee ID:", data);
                $('#EmployeeID').val(data);
            },
            error: function () {
                alert('Failed to get Employee Next ID');
            }
        });
    }
    $('#photo').on('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                $('#photoPreview').attr('src', e.target.result).show();
                $('#photoPlaceholder').hide();
                $('#photoPHText').hide();

            };
            reader.readAsDataURL(file);
        }
    });
    

     $('#clearBtn').on('click',function(){
         clear();
     });
    function clear(){
        $('#employeeForm')[0].reset();      
        $('#AutoID').val('0');
        GetEmployeeNextID();
        $('#photoPlaceholder').show();
        $('#photoPHText').show();
        $('#photoPreview').attr('src', '').hide();

    }
    $('#pic_clearBtn') .on('click',function(){
         $('#photoPlaceholder').show();
         $('#photoPHText').show();
        $('#photoPreview').attr('src', '').hide();
        $('#photo').val('');
        
    });

    // Photo Edit Button
    $('#employeeTable').on('click','.editBtn', function() {
        var employeeId = $(this).data('id');
        $.ajax({
            url:'/EmployeeInfoController1/GetById',
            type:'GET',
            data:{id: employeeId},
            success:function(data){
                if(data){
                    console.log(data);
                    if(data.photoPath != null){
                        $('#photoPlaceholder').hide();
                        $('#photoPHText').hide();
                        $('#photoPreview').attr('src', `Image/${data.photoPath}`).show();
                    } else{
                        $('#photoPlaceholder').show();
                        $('#photoPHText').show();
                        $('#photoPreview').attr('src', '').hide();
                    }
                    $('#EmployeeID').val(data.employeeID);
                    $('#AutoID').val(data.autoID);
                    $('#Name').val(data.name);
                    $('#Designation').val(data.designation);
                    $('#Department').val(data.department);
                    $('#GrossSalary').val(data.grossSalary);
                    $('#JoiningDate').val(data.joiningDate.split('T')[0]);
                    $('#Address').val(data.address);
                    $('#Phone').val(data.phone);
                    $('#Email').val(data.email);
                }
            },
            error: function(){
                alert('Not Found')
            }
        });

    });


    // function submitFormWithAjax() {
        $('#employeeForm').on('submit', function(e) {
            e.preventDefault(); // Prevent normal form submission

            const formData = new FormData(this);
            
            $.ajax({
                url: 'EmployeeInfoController1/Save',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log('Success:', response);
                    alert('Employee saved successfully!');
                    clear();
                    // Reload the employee list or redirect
                    location.reload();
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('Error saving employee: ' + error);
                }
            });
        });

            $('#deleteBtn').click(function () {
        var ids = [];
        $('.selectsingle:checked').each(function () {
            ids.push($(this).val());
            console.log(ids);
        });
        if (ids.length == 0) {
            var employeeId = $('#AutoID').val();
            if (employeeId && employeeId.trim() !== '') {
                if (confirm('Are you sure you want to delete this employee?')) {
                    $.ajax({
                        url: '/EmployeeInfoController1/Delete',
                        type: 'POST',
                        data: { id: employeeId },
                        success: function (response) {
                            if (response.success) {
                                $('#row_' + employeeId).remove();
                                alert('Employee Deleted successfully');
                                 location.reload();
                                $('#employeeForm')[0].reset();
                            } else {
                                alert('Error deleting employee');
                            }
                        },
                        error: function () {
                            alert('Error deleting employee');
                        }
                    });
                }
            } else {
                alert('Please select an employee to delete');
            }
        } else {
            if (confirm('Are you sure you want to delete this ' + ids.length + ' employees?')) {
                $.ajax({
                    url: '/EmployeeInfoController1/BulkDelete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(ids),
                    success: function (response) {
                        if (response.success) {
                            alert('Employees deleted successfully');
                            location.reload();
                        }
                    },
                    error: function () {
                        alert('Error detecting while deleting employees');
                    }
                });
            }
        }
    });
    $('#selectAll').on ('click',function(){
        var isChecked = $(this).prop('checked');
        console.log(isChecked);
        $('.selectsingle').prop('checked',isChecked);
    });




    // }
</script>

